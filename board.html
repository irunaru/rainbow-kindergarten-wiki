<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìš°ë¦¬ë°˜ ì´ì•¼ê¸°íŒ ğŸŒˆ</title>
  <style>
    :root { --main: #FFB7B2; --bg: #FFF9C4; --card: #FFFFFF; --text: #5D4037; }
    body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; line-height: 1.6; }
    header { background: var(--main); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .container { max-width: 500px; margin: 0 auto; padding: 15px; }
    .card { background: var(--card); border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid transparent; }
    .post-meta { font-size: 0.85rem; color: #888; margin-bottom: 8px; display: flex; justify-content: space-between; }
    .post-body { font-size: 1.1rem; white-space: pre-wrap; }
    input, textarea { width: 100%; border: 2px solid #eee; border-radius: 10px; padding: 12px; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; }
    button { background: var(--main); color: white; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; font-size: 1rem; }
    button:active { opacity: 0.8; }
    .nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; z-index: 10; }
    .nav-btn { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-size: 1.1rem; transition: background 0.2s; }
    .nav-btn:hover { background: #fff5f5; }
    
    /* ëª¨ë‹¬ */
    #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(3px); }
    .modal-content { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; }
    
    /* ëŒ“ê¸€ ìŠ¤íƒ€ì¼ */
    .comment-list { margin-top: 20px; background: #fffdf0; border-radius: 10px; padding: 10px; }
    .comment-item { padding: 10px; border-bottom: 1px solid #eee; }
    .comment-item:last-child { border-bottom: none; }
    .comment-author { font-weight: bold; color: #FF8A80; font-size: 0.9rem; }
    .comment-body { font-size: 0.95rem; margin-top: 3px; }
  </style>
</head>
<body>

<header><h2 id="title">ìš°ë¦¬ë°˜ ì´ì•¼ê¸°íŒ</h2></header>

<div class="container" id="app">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<div class="nav">
  <div class="nav-btn" onclick="location.hash='#home'">ğŸ¡ í™ˆ</div>
  <div class="nav-btn" onclick="location.hash='#free'">ğŸ“¢ ê²Œì‹œíŒ</div>
</div>

<div id="modal">
  <div class="modal-content">
    <h3 style="margin-top:0">ğŸ“› ì´ë¦„í‘œ ë§Œë“¤ê¸°</h3>
    <p>ìš°ë¦¬ë°˜ ì¹œêµ¬ë“¤ì´ ì•Œì•„ë³¼ ìˆ˜ ìˆê²Œ<br>ì´ë¦„ì„ ì ì–´ì£¼ì„¸ìš”!</p>
    <input type="text" id="nick-input" placeholder="ì˜ˆ: ë¬´ì§€ê°œê¸°ë¦°">
    <button onclick="saveNickname()">êµì‹¤ ì…ì¥!</button>
  </div>
</div>

<script>
  // [1] ë³¸ì¸ì˜ API ì£¼ì†Œ (ëì— /api/v1ì„ ë¶™ì—¬ ê²½ë¡œë¥¼ ë‹¨ìˆœí™”í•©ë‹ˆë‹¤)
  const API_URL = "https://rainbow-bbs-api.irunaru.workers.dev/api/v1";
  
  let myNick = localStorage.getItem('bbs_nick');
  let myGid = localStorage.getItem('bbs_gid') || crypto.randomUUID();

  // ì•± ì‹œì‘
  async function init() {
    if (!myNick) {
      document.getElementById('modal').style.display = 'flex';
    } else {
      localStorage.setItem('bbs_gid', myGid);
      window.onhashchange = router;
      router();
    }
  }

  // ë‹‰ë„¤ì„ ì €ì¥
  async function saveNickname() {
    const n = document.getElementById('nick-input').value.trim();
    if(n.length < 2) return alert("ë‘ ê¸€ì ì´ìƒ ì¨ì£¼ì„¸ìš”!");
    
    try {
      const res = await fetch(`${API_URL}/guest/init`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ guest_id: myGid, nickname: n })
      });
      if (!res.ok) throw new Error();
      
      localStorage.setItem('bbs_nick', n);
      localStorage.setItem('bbs_gid', myGid);
      location.reload();
    } catch(e) { 
      alert("ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ í•´ë³´ì„¸ìš”!"); 
    }
  }

  // í™”ë©´ ì „í™˜ (ë¼ìš°í„°)
  async function router() {
    const hash = location.hash || '#home';
    const app = document.getElementById('app');
    const title = document.getElementById('title');

    if (hash === '#home') {
      title.innerText = "ğŸ¡ ìš°ë¦¬ë°˜ ì¹œêµ¬ë“¤";
      app.innerHTML = '<div class="card">ìºë¦­í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      try {
        const res = await fetch(`${API_URL}/characters`);
        const chars = await res.json();
        app.innerHTML = chars.map(c => `
          <div class="card" style="text-align:center">
            <div style="font-size:3.5rem; margin-bottom:10px;">${c.avatar_url || 'ğŸ‘¤'}</div>
            <strong style="font-size:1.2rem">${c.display_name}</strong>
            <p style="color:#888; font-size:0.9rem; margin-top:5px;">${c.bio || 'ë°˜ê°€ì›Œìš”!'}</p>
          </div>
        `).join('');
      } catch(e) { app.innerHTML = "ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."; }
    } 

    else if (hash === '#free') {
      title.innerText = "ğŸ“¢ ì´ì•¼ê¸° ê²Œì‹œíŒ";
      app.innerHTML = `
        <div class="card" style="border: 2px solid var(--main)">
          <textarea id="post-body" rows="3" placeholder="ì˜¤ëŠ˜ ì–´ë–¤ ê¸°ë¶„ì¸ê°€ìš”? ì¹œêµ¬ë“¤ì—ê²Œ ë“¤ë ¤ì£¼ì„¸ìš”."></textarea>
          <button onclick="createPost()">ê¸€ ì˜¬ë¦¬ê¸°</button>
        </div>
        <div id="list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      `;
      loadPosts();
    }

    else if (hash.startsWith('#p=')) {
      const id = hash.split('=')[1];
      showPostDetail(id);
    }
  }

  // ê²Œì‹œê¸€ ëª©ë¡ ë¡œë“œ
  async function loadPosts() {
    try {
      const res = await fetch(`${API_URL}/posts`);
      const posts = await res.json();
      const listEl = document.getElementById('list');
      if (posts.length === 0) {
        listEl.innerHTML = '<div class="card" style="text-align:center; color:#999;">ì²« ë²ˆì§¸ ê¸€ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!</div>';
        return;
      }
      listEl.innerHTML = posts.map(p => `
        <div class="card" onclick="location.hash='#p=${p.id}'">
          <div class="post-meta">
            <span>ğŸ‘¤ <b>${p.guests?.nickname || p.author_name}</b></span>
            <span>${new Date(p.created_at).toLocaleDateString()}</span>
          </div>
          <div class="post-body">${p.body}</div>
          <div style="font-size:0.85rem; color:var(--main); margin-top:12px; font-weight:bold;">ğŸ’¬ ëŒ“ê¸€ ë³´ëŸ¬ê°€ê¸° â†’</div>
        </div>
      `).join('');
    } catch(e) { document.getElementById('list').innerHTML = "ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; }
  }

  // ê¸€ ìƒì„¸ ë³´ê¸° & ëŒ“ê¸€ ëª©ë¡
  async function showPostDetail(id) {
    const app = document.getElementById('app');
    app.innerHTML = '<div class="card">ë‚´ìš©ì„ ì½ì–´ì˜¤ëŠ” ì¤‘...</div>';
    
    try {
      const res = await fetch(`${API_URL}/posts/${id}`);
      const data = await res.json();
      
      document.getElementById('title').innerText = "ìƒì„¸ ë³´ê¸°";
      app.innerHTML = `
        <button onclick="location.hash='#free'" style="background:#bbb; margin-bottom:15px;">â¬…ï¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        <div class="card">
          <div class="post-meta">
            <b>${data.post.guests?.nickname || data.post.author_name}</b>
            <span>${new Date(data.post.created_at).toLocaleString()}</span>
          </div>
          <div class="post-body" style="font-size:1.2rem">${data.post.body}</div>
        </div>
        
        <h4 style="margin:20px 0 10px 5px">ğŸ’¬ ëŒ“ê¸€ (${data.comments.length})</h4>
        <div class="comment-list">
          ${data.comments.length > 0 ? data.comments.map(c => `
            <div class="comment-item">
              <div class="comment-author">${c.author_name}</div>
              <div class="comment-body">${c.body}</div>
            </div>
          `).join('') : '<div style="text-align:center; padding:10px; color:#aaa;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ì–´ìš”.</div>'}
        </div>

        <div class="card" style="margin-top:20px; border-top: 3px solid var(--main);">
          <input id="cmt-input" placeholder="ë”°ëœ»í•œ í•œë§ˆë””ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!">
          <button onclick="addComment(${id})">ëŒ“ê¸€ ì“°ê¸°</button>
        </div>
      `;
    } catch(e) { app.innerHTML = "ê¸€ì´ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; }
  }

  // ê¸€ ì‘ì„± ê¸°ëŠ¥
  async function createPost() {
    const body = document.getElementById('post-body').value.trim();
    if(!body) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");

    // ì‹¤ì œë¡œëŠ” ë³„ë„ì˜ POST /posts APIê°€ í•„ìš”í•©ë‹ˆë‹¤ (í˜„ì¬ ì›Œì»¤ì— êµ¬í˜„ëœ ë¡œì§ ì‚¬ìš©)
    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ êµ¬í˜„ ì˜ˆì‹œë§Œ ë³´ì—¬ë“œë¦¬ë©°, ì›Œì»¤ì— í•´ë‹¹ ê²½ë¡œê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
    alert("ì¤€ë¹„ ì¤‘ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤! (ë°±ì—”ë“œì— ê¸€ì“°ê¸° API ì¶”ê°€ í•„ìš”)");
  }

  // ëŒ“ê¸€ ë“±ë¡ ê¸°ëŠ¥
  async function addComment(postId) {
    const bodyEl = document.getElementById('cmt-input');
    const body = bodyEl.value.trim();
    if(!body) return alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì¨ì£¼ì„¸ìš”!");

    try {
      const res = await fetch(`${API_URL}/posts/${postId}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          guest_id: myGid,
          nickname: myNick,
          body: body
        })
      });

      if(res.ok) {
        bodyEl.value = '';
        showPostDetail(postId); // ìƒˆë¡œê³ ì¹¨
      } else {
        alert("ëŒ“ê¸€ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
    } catch(e) { alert("ì—°ê²° ì˜¤ë¥˜ ë°œìƒ!"); }
  }

  init();
</script>
</body>
</html>

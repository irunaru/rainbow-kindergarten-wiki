<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒˆ ë¬´ì§€ê°œ êµì‹¤</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
      background: #f0f8ff;
      color: #333;
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    header {
      background: #ffd966;
      padding: 12px 16px;
      border-radius: 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1 { font-size: 1.8rem; cursor: pointer; }
    .nav button {
      background: white;
      border: none;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 1rem;
      margin-left: 8px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card {
      background: white;
      border-radius: 30px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 6px 10px rgba(0,0,0,0.05);
    }
    .character-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .character-item { text-align: center; cursor: pointer; }
    .character-item img {
      width: 80px; height: 80px;
      border-radius: 50%;
      background: #ffe599;
      object-fit: cover;
      border: 3px solid #ffb6c1;
    }
    .post-list, .comment-list { list-style: none; }
    .post-item, .comment-item {
      border-bottom: 1px solid #eee;
      padding: 12px 0;
      cursor: pointer;
    }
    .comment-item { cursor: default; }
    .post-meta, .comment-meta { font-size: 0.8rem; color: #888; }
    .post-content { margin: 8px 0; }
    .btn {
      background: #b6d7a8;
      border: none;
      border-radius: 30px;
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 8px;
      margin-top: 8px;
    }
    .btn-small { font-size: 0.8rem; padding: 4px 8px; }
    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 20px;
      font-size: 1rem;
      margin: 8px 0;
    }
    .admin-section {
      background: #fce5cd;
      border-radius: 20px;
      padding: 16px;
      margin-top: 20px;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <h1 id="logo">ğŸŒˆ ë¬´ì§€ê°œ êµì‹¤</h1>
    <div class="nav">
      <button id="btn-home">ğŸ </button>
      <button id="btn-free">ğŸ“¢ ììœ </button>
    </div>
  </header>

  <div id="nickname-banner" class="card" style="display:none;">
    <div>ë‚´ ì´ë¦„í‘œ: <span id="current-nickname">ì—†ìŒ</span></div>
    <button id="btn-set-nickname" class="btn-small">ì´ë¦„í‘œ ë¶™ì´ê¸°</button>
  </div>

  <div id="app"></div>

  <div id="admin-dialog" class="admin-section hidden">
    <h3>ğŸ” ì„ ìƒë‹˜ ë°©</h3>
    <input type="password" id="admin-key-input" placeholder="ë¹„ë°€í‚¤">
    <button id="btn-admin-login" class="btn-small">ë“¤ì–´ê°€ê¸°</button>

    <div id="admin-panel" class="hidden">
      <h4>ğŸ‘¤ ìƒˆ ìºë¦­í„° ë§Œë“¤ê¸°</h4>
      <input type="text" id="new-char-name" placeholder="ì´ë¦„">
      <input type="text" id="new-char-role" placeholder="ì—­í•  (ì˜ˆ: ë¬´ì§€ê°œ ì›ìƒ)">
      <button id="btn-create-character" class="btn-small">ë§Œë“¤ê¸°</button>

      <h4>âœï¸ ìºë¦­í„°ë¡œ ê¸€ì“°ê¸° (êµì‹¤ ì´ì•¼ê¸°íŒ)</h4>
      <select id="admin-char-select"></select>
      <input type="text" id="admin-post-title" placeholder="ì œëª©">
      <textarea id="admin-post-content" placeholder="ë‚´ìš©"></textarea>
      <button id="btn-post-as-character" class="btn-small">ì˜¬ë¦¬ê¸°</button>
    </div>
  </div>

<script>
(() => {
  const API_BASE = "https://rainbow-bbs-api.irunaru.workers.dev/api/v1"; // âœ… ë„¤ Worker ì£¼ì†Œë¡œ

  let adminKey = sessionStorage.getItem("adminKey") || "";
  let currentGuest = null;   // {id,nickname,is_blocked}
  let characters = [];       // [{id,name,role,...}]

  const esc = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
  const nl2br = (s) => esc(s).replace(/\n/g, "<br>");

  async function apiCall(path, options = {}) {
    const res = await fetch(API_BASE + path, {
      ...options,
      credentials: "include",
      headers: {
        "Content-Type": "application/json",
        ...(adminKey ? {"X-Admin-Key": adminKey} : {}),
        ...(options.headers || {})
      }
    });
    const data = await res.json().catch(() => null);
    if (!res.ok || !data || data.ok === false) throw new Error(data?.error || `http_${res.status}`);
    return data;
  }

  async function initGuest() {
    const me = await apiCall("/guest/me");
    if (me.guest && me.guest.id) {
      currentGuest = me.guest;
    } else {
      await apiCall("/guest/init", { method:"POST" });
      const me2 = await apiCall("/guest/me");
      currentGuest = me2.guest;
    }
    document.getElementById("nickname-banner").style.display = "flex";
    document.getElementById("current-nickname").textContent = currentGuest?.nickname || "ì—†ìŒ";
  }

  async function loadCharacters() {
    const data = await apiCall("/characters");
    characters = data.characters || [];
  }

  function router() {
    const hash = window.location.hash.slice(1) || "home";
    if (hash === "home") renderHome();
    else if (hash === "free") renderFreeboard();
    else if (hash.startsWith("u=")) renderCharacter(decodeURIComponent(hash.split("=")[1]));
    else if (hash.startsWith("p=")) renderPost(decodeURIComponent(hash.split("=")[1]));
    else renderHome();
  }

  async function renderHome() {
    await loadCharacters();
    let html = `<div class="card"><h2>ğŸŒˆ ìš°ë¦¬ ë°˜ ì¹œêµ¬ë“¤</h2><div class="character-grid">`;
    characters.forEach(c => {
      const initial = (c.name || "?").slice(0,1);
      const img = `https://via.placeholder.com/80/ffb6c1/fff?text=${encodeURIComponent(initial)}`;
      html += `
        <div class="character-item" onclick="location.hash='u=${encodeURIComponent(c.id)}'">
          <img src="${img}" alt="${esc(c.name)}">
          <div>${esc(c.name)}</div><small>${esc(c.role)}</small>
        </div>`;
    });
    html += `</div></div>`;
    document.getElementById("app").innerHTML = html;
  }

  async function renderCharacter(slug) {
    const char = (await apiCall(`/characters/${encodeURIComponent(slug)}`)).character;
    const posts = (await apiCall(`/characters/${encodeURIComponent(slug)}/posts`)).posts || [];

    let html = `<div class="card">
      <h2>${esc(char.name)} (${esc(char.role)})</h2>
      <p>${esc(char.bio || "")}</p>`;

    if (adminKey) {
      html += `<button class="btn-small" onclick="window.__adminQuickPost('${esc(char.id)}')">âœï¸ ì´ ìºë¦­í„°ë¡œ ê¸€ì“°ê¸°</button>`;
    }

    html += `<h3>ğŸ“ ê²Œì‹œê¸€</h3><ul class="post-list">`;
    posts.forEach(p => {
      html += `<li class="post-item" onclick="location.hash='p=${encodeURIComponent(p.id)}'">
        <strong>${esc(p.title)}</strong><br>
        <span class="post-meta">${new Date(p.created_at).toLocaleString()}</span>
      </li>`;
    });
    html += `</ul></div>`;
    document.getElementById("app").innerHTML = html;
  }

  async function renderFreeboard() {
    const posts = (await apiCall("/boards/free/posts")).posts || [];
    let html = `<div class="card"><h2>ğŸ“¢ ììœ ê²Œì‹œíŒ</h2>
      <button class="btn" onclick="window.__showNewPostForm()">âœï¸ ìƒˆ ê¸€ì“°ê¸°</button>
      <ul class="post-list">`;

    posts.forEach(p => {
      html += `<li class="post-item" onclick="location.hash='p=${encodeURIComponent(p.id)}'">
        <strong>${esc(p.title)}</strong><br>
        <span class="post-meta">${esc(p.author_name || "ì¹œêµ¬")} Â· ${new Date(p.created_at).toLocaleString()}</span>
      </li>`;
    });

    html += `</ul></div>`;
    document.getElementById("app").innerHTML = html;
  }

  async function renderPost(postId) {
    const data = await apiCall(`/posts/${encodeURIComponent(postId)}`);
    const post = data.post;
    const comments = data.comments || [];

    let html = `<div class="card">
      <h2>${esc(post.title)}</h2>
      <div class="post-meta">ì‘ì„±: ${esc(post.author_name || "ì¹œêµ¬")} Â· ${new Date(post.created_at).toLocaleString()}</div>
      <div class="post-content">${nl2br(post.content)}</div>`;

    // ë³¸ì¸ ê¸€ ì‚­ì œ(ê²ŒìŠ¤íŠ¸ ê¸€ì¸ ê²½ìš°ë§Œ)
    if (post.author_type === "guest" && currentGuest?.id && post.guest_id === currentGuest.id) {
      html += `<button class="btn-small" onclick="window.__deletePost('${esc(post.id)}')">ì‚­ì œ</button>`;
    }

    html += `<h3>ğŸ’¬ ëŒ“ê¸€</h3><ul class="comment-list">`;
    comments.forEach(c => {
      html += `<li class="comment-item">
        <span class="comment-meta">${esc(c.author_name || "ì¹œêµ¬")} Â· ${new Date(c.created_at).toLocaleString()}</span>
        <div>${nl2br(c.body)}</div>`;
      if (c.author_type === "guest" && currentGuest?.id && c.guest_id === currentGuest.id) {
        html += `<button class="btn-small" onclick="window.__deleteComment('${esc(c.id)}','${esc(post.id)}')">ì‚­ì œ</button>`;
      }
      html += `</li>`;
    });
    html += `</ul>
      <div>
        <textarea id="new-comment" placeholder="ëŒ“ê¸€ ì“°ê¸°..."></textarea>
        <button class="btn" onclick="window.__addComment('${esc(post.id)}')">ë“±ë¡</button>
      </div>
    </div>`;

    document.getElementById("app").innerHTML = html;
  }

  // --- write flows ---
  window.__showNewPostForm = () => {
    document.getElementById("app").innerHTML = `
      <div class="card">
        <h3>ìƒˆ ê¸€ ì“°ê¸°</h3>
        <input id="post-title" placeholder="ì œëª©">
        <textarea id="post-body" placeholder="ë‚´ìš©"></textarea>
        <button class="btn" onclick="window.__submitFreePost()">ì˜¬ë¦¬ê¸°</button>
        <button class="btn" onclick="location.hash='free'">ì·¨ì†Œ</button>
      </div>`;
  };

  async function ensureNickname() {
    if (currentGuest?.nickname) return true;
    const nick = prompt("ì´ì•¼ê¸° ë‚˜ëˆ„ê¸°ì— ì“¸ ì´ë¦„ì„ ì •í•´ì£¼ì„¸ìš”!");
    if (!nick) return false;
    await apiCall("/guest/nickname", { method:"POST", body: JSON.stringify({ nickname: nick }) });
    await initGuest();
    return !!currentGuest?.nickname;
  }

  window.__submitFreePost = async () => {
    const title = document.getElementById("post-title").value.trim();
    const body = document.getElementById("post-body").value.trim();
    if (!title || !body) return alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");
    if (!(await ensureNickname())) return;

    await apiCall("/boards/free/posts", {
      method:"POST",
      body: JSON.stringify({ title, body })
    });
    location.hash = "free";
  };

  window.__addComment = async (postId) => {
    const body = document.getElementById("new-comment").value.trim();
    if (!body) return;
    if (!(await ensureNickname())) return;

    await apiCall(`/posts/${encodeURIComponent(postId)}/comments`, {
      method:"POST",
      body: JSON.stringify({ body })
    });
    await renderPost(postId);
  };

  window.__deletePost = async (postId) => {
    if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
    await apiCall(`/posts/${encodeURIComponent(postId)}`, { method:"DELETE" });
    location.hash = "free";
  };

  window.__deleteComment = async (commentId, postId) => {
    if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) return;
    await apiCall(`/comments/${encodeURIComponent(commentId)}`, { method:"DELETE" });
    await renderPost(postId);
  };

  // --- admin ---
  async function loadCharactersForAdmin() {
    await loadCharacters();
    const select = document.getElementById("admin-char-select");
    select.innerHTML = characters.map(c => `<option value="${esc(c.id)}">${esc(c.name)}</option>`).join("");
  }

  document.getElementById("btn-admin-login").addEventListener("click", async () => {
    const key = document.getElementById("admin-key-input").value.trim();
    if (!key) return alert("ë¹„ë°€í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    adminKey = key;
    sessionStorage.setItem("adminKey", key);
    document.getElementById("admin-panel").classList.remove("hidden");
    await loadCharactersForAdmin();
    alert("ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”");
  });

  document.getElementById("btn-create-character").addEventListener("click", async () => {
    const name = document.getElementById("new-char-name").value.trim();
    const role = document.getElementById("new-char-role").value.trim();
    if (!name || !role) return alert("ì´ë¦„ê³¼ ì—­í• ì€ í•„ìˆ˜ì˜ˆìš”");

    await apiCall("/admin/characters", { method:"POST", body: JSON.stringify({ name, role }) });
    alert("ìºë¦­í„° ìƒì„± ì™„ë£Œ!");
    await loadCharactersForAdmin();
  });

  document.getElementById("btn-post-as-character").addEventListener("click", async () => {
    const slug = document.getElementById("admin-char-select").value;
    const title = document.getElementById("admin-post-title").value.trim();
    const body = document.getElementById("admin-post-content").value.trim();
    if (!title || !body) return alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

    await apiCall(`/admin/characters/${encodeURIComponent(slug)}/posts`, {
      method:"POST",
      body: JSON.stringify({ title, body })
    });
    alert("ê²Œì‹œ ì™„ë£Œ!");
    location.hash = `u=${encodeURIComponent(slug)}`;
  });

  window.__adminQuickPost = async (slug) => {
    document.getElementById("admin-dialog").classList.remove("hidden");
    document.getElementById("admin-panel").classList.remove("hidden");
    await loadCharactersForAdmin();
    document.getElementById("admin-char-select").value = slug;
    alert("ì•„ë˜ 'ìºë¦­í„°ë¡œ ê¸€ì“°ê¸°'ì—ì„œ ì‘ì„±í•˜ì„¸ìš”.");
  };

  document.getElementById("logo").addEventListener("dblclick", () => {
    document.getElementById("admin-dialog").classList.toggle("hidden");
  });

  document.getElementById("btn-home").addEventListener("click", () => location.hash = "home");
  document.getElementById("btn-free").addEventListener("click", () => location.hash = "free");

  document.getElementById("btn-set-nickname").addEventListener("click", async () => {
    const nick = prompt("êµì‹¤ì—ì„œ ë¶€ë¥¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if (!nick) return;
    await apiCall("/guest/nickname", { method:"POST", body: JSON.stringify({ nickname: nick }) });
    await initGuest();
  });

  window.addEventListener("hashchange", router);

  (async () => {
    await initGuest();
    await loadCharacters();
    router();
  })();

})();
</script>
</body>
</html>

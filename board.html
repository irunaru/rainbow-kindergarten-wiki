<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>무지개 유치원 BBS</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background:#f6f6f6; }
    header { position: sticky; top:0; background:#fff; padding:12px 14px; border-bottom:1px solid #ddd; display:flex; gap:10px; align-items:center; }
    header .title { font-weight:700; }
    header .spacer { flex:1; }
    header button { border:1px solid #ccc; background:#fff; border-radius:10px; padding:8px 10px; }
    main { padding: 14px; max-width: 820px; margin: 0 auto; }
    .tabs { display:flex; gap:8px; margin:10px 0 14px; }
    .tab { padding:8px 10px; border-radius:999px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .tab.active { border-color:#333; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap:12px; }
    .card { background:#fff; border:1px solid #e3e3e3; border-radius:14px; padding:10px; text-align:center; cursor:pointer; }
    .avatar { width:64px; height:64px; border-radius:50%; object-fit:cover; background:#eee; margin:0 auto 8px; }
    .badge { font-size:12px; opacity:.7; }
    .list { display:flex; flex-direction:column; gap:10px; }
    .item { background:#fff; border:1px solid #e3e3e3; border-radius:14px; padding:12px; cursor:pointer; }
    .meta { display:flex; gap:10px; font-size:12px; opacity:.7; margin-top:6px; }
    .btnPrimary { border:0; background:#111; color:#fff; border-radius:12px; padding:10px 12px; }
    .row { display:flex; gap:10px; align-items:center; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:14px; }
    .modal .box { background:#fff; border-radius:16px; padding:14px; width:min(420px, 100%); border:1px solid #ddd; }
    .modal input, .modal textarea { width:100%; box-sizing:border-box; padding:10px; border-radius:12px; border:1px solid #ccc; margin:8px 0; }
    .modal textarea { min-height:120px; }
    .hint { font-size:12px; opacity:.7; }
    .danger { color:#b00020; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div class="title" id="hdrTitle">무지개 유치원</div>
    <div class="spacer"></div>
    <button id="meBtn">이름표</button>
  </header>

  <main>
    <div class="tabs">
      <div class="tab" id="tabHome">캐릭터</div>
      <div class="tab" id="tabFree">자유게시판</div>
    </div>

    <div id="view"></div>
  </main>

  <!-- Nickname modal -->
  <div class="modal" id="nickModal">
    <div class="box">
      <div style="font-weight:700;">이름표 붙이기</div>
      <div class="hint">교실에서 부를 이름을 적어줘 (2~12자)</div>
      <input id="nickInput" placeholder="예: 빨강이친구" />
      <div class="row">
        <button class="btnPrimary" id="nickSave">저장</button>
        <button id="nickCancel">취소</button>
      </div>
      <div class="danger" id="nickErr" style="display:none;"></div>
    </div>
  </div>

  <!-- Admin key modal -->
  <div class="modal" id="adminModal">
    <div class="box">
      <div style="font-weight:700;">관리자 모드</div>
      <div class="hint">관리자 키를 입력하세요 (이 탭에서만 유지)</div>
      <input id="adminKeyInput" placeholder="ADMIN_KEY" />
      <div class="row">
        <button class="btnPrimary" id="adminKeySave">활성화</button>
        <button id="adminKeyCancel">닫기</button>
      </div>
      <div class="danger" id="adminErr" style="display:none;"></div>
    </div>
  </div>

  <!-- Compose modal (free post or character post) -->
  <div class="modal" id="composeModal">
    <div class="box">
      <div style="font-weight:700;" id="composeTitle">글쓰기</div>
      <div id="composeCharRow" style="display:none;">
        <div class="hint">캐릭터 선택</div>
        <input id="composeCharId" placeholder="예: kid-red" />
      </div>
      <input id="composePostTitle" placeholder="제목" />
      <textarea id="composePostBody" placeholder="내용"></textarea>
      <div class="row">
        <button class="btnPrimary" id="composeSubmit">등록</button>
        <button id="composeCancel">취소</button>
      </div>
      <div class="danger" id="composeErr" style="display:none;"></div>
    </div>
  </div>

<script>
(() => {
  // ===== CONFIG =====
  const API = "https://rainbow-bbs-api.irunaru.workers.dev";
  // ==================

  // admin key only in-memory (tab session)
  let ADMIN_KEY = null;

  const el = (id) => document.getElementById(id);
  const view = el("view");
  const hdrTitle = el("hdrTitle");

  const nickModal = el("nickModal");
  const nickInput = el("nickInput");
  const nickErr = el("nickErr");

  const adminModal = el("adminModal");
  const adminKeyInput = el("adminKeyInput");
  const adminErr = el("adminErr");

  const composeModal = el("composeModal");
  const composeTitle = el("composeTitle");
  const composeCharRow = el("composeCharRow");
  const composeCharId = el("composeCharId");
  const composePostTitle = el("composePostTitle");
  const composePostBody = el("composePostBody");
  const composeErr = el("composeErr");

  const state = {
    me: null,
    characters: [],
    freePosts: [],
    char: null,
    charPosts: [],
    postDetail: null,
  };

  // --- HTTP helper ---
  async function api(path, opts = {}) {
    const init = {
      ...opts,
      headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
      credentials: "include",
    };
    const res = await fetch(API + path, init);
    const data = await res.json().catch(() => ({}));
    if (!res.ok || data.ok === false) {
      const msg = data?.error || ("http_" + res.status);
      throw new Error(msg);
    }
    return data;
  }

  async function ensureGuest() {
    await api("/api/v1/guest/init", { method: "POST" });
  }

  async function ensureNickname() {
    // cheap check: try setting me by reading current nickname presence via a lightweight call:
    // We don't have /me endpoint in worker minimal version; so we infer by trying to write and handling 403.
    // Better: add /me later. For now we just show modal when user tries to post/comment and nickname fails.
    return true;
  }

  // --- UI helpers ---
  function setTabs(active) {
    el("tabHome").classList.toggle("active", active === "home");
    el("tabFree").classList.toggle("active", active === "free");
  }

  function openModal(m) { m.style.display = "flex"; }
  function closeModal(m) { m.style.display = "none"; }

  function fmtTime(iso) {
    try {
      const d = new Date(iso);
      return d.toLocaleString("ko-KR", { month:"numeric", day:"numeric", hour:"2-digit", minute:"2-digit" });
    } catch { return ""; }
  }

  // --- Renderers ---
  function renderHome() {
    hdrTitle.textContent = "무지개 유치원";
    setTabs("home");

    const items = state.characters.map(c => `
      <div class="card" data-char="${c.id}">
        <img class="avatar" src="${c.avatar_url || ""}" alt="" />
        <div style="font-weight:700;">${escapeHtml(c.name)}</div>
        <div class="badge">${escapeHtml(c.role)}</div>
      </div>
    `).join("");

    view.innerHTML = `
      <div class="hint">원생/선생님을 눌러 프로필(SNS)로 들어가세요.</div>
      <div class="grid" id="charGrid">${items || "<div class='hint'>캐릭터가 없습니다.</div>"}</div>
    `;

    el("charGrid").onclick = (e) => {
      const card = e.target.closest("[data-char]");
      if (!card) return;
      location.hash = `#u=${encodeURIComponent(card.dataset.char)}`;
    };
  }

  function renderCharacter() {
    const c = state.char;
    hdrTitle.textContent = c ? c.name : "프로필";
    setTabs("home");

    const adminBtn = ADMIN_KEY ? `<button class="btnPrimary" id="btnCharWrite">이 캐릭터로 글쓰기</button>` : "";

    const posts = state.charPosts.map(p => `
      <div class="item" data-post="${p.id}">
        <div style="font-weight:700;">${escapeHtml(p.title)}</div>
        <div class="meta">
          <span>캐릭터</span>
          <span>${fmtTime(p.created_at)}</span>
          <span>댓글 ${p.comment_count ?? 0}</span>
        </div>
      </div>
    `).join("");

    view.innerHTML = `
      <div class="row" style="margin-bottom:12px;">
        <button id="btnBack">←</button>
        <div class="spacer"></div>
        ${adminBtn}
      </div>
      ${c ? `
        <div class="item" style="cursor:default;">
          <div class="row">
            <img class="avatar" src="${c.avatar_url || ""}" alt="" />
            <div>
              <div style="font-weight:700;">${escapeHtml(c.name)}</div>
              <div class="hint">${escapeHtml(c.bio || "")}</div>
            </div>
          </div>
        </div>
      ` : ""}
      <div style="height:10px;"></div>
      <div class="list">${posts || "<div class='hint'>아직 글이 없어요.</div>"}</div>
    `;

    el("btnBack").onclick = () => history.back();

    const list = view.querySelector(".list");
    list.onclick = (e) => {
      const it = e.target.closest("[data-post]");
      if (!it) return;
      location.hash = `#p=${it.dataset.post}`;
    };

    const btn = el("btnCharWrite");
    if (btn) {
      btn.onclick = () => openCompose({ mode: "char", characterId: c.id });
    }
  }

  function renderFree() {
    hdrTitle.textContent = "자유게시판";
    setTabs("free");

    const posts = state.freePosts.map(p => `
      <div class="item" data-post="${p.id}">
        <div style="font-weight:700;">${escapeHtml(p.title)}</div>
        <div class="meta">
          <span>${p.author_type === "system" ? "캐릭터" : "친구"}</span>
          <span>${fmtTime(p.created_at)}</span>
          <span>댓글 ${p.comment_count ?? 0}</span>
        </div>
      </div>
    `).join("");

    view.innerHTML = `
      <div class="row" style="margin-bottom:12px;">
        <button class="btnPrimary" id="btnFreeWrite">글쓰기</button>
        <div class="hint">HOT/BEST는 나중에 단계적으로 적용</div>
      </div>
      <div class="list" id="freeList">${posts || "<div class='hint'>첫 글을 써보세요.</div>"}</div>
    `;

    el("btnFreeWrite").onclick = () => openCompose({ mode: "free" });

    el("freeList").onclick = (e) => {
      const it = e.target.closest("[data-post]");
      if (!it) return;
      location.hash = `#p=${it.dataset.post}`;
    };
  }

  function renderPostDetail() {
    const d = state.postDetail;
    if (!d) {
      view.innerHTML = `<div class="hint">글을 찾을 수 없습니다.</div>`;
      return;
    }
    const p = d.post;
    hdrTitle.textContent = "글";

    const comments = d.comments.map(c => `
      <div class="item" style="cursor:default;">
        <div>${escapeHtml(c.body)}</div>
        <div class="meta"><span>${fmtTime(c.created_at)}</span></div>
      </div>
    `).join("");

    view.innerHTML = `
      <div class="row" style="margin-bottom:12px;">
        <button id="btnBack">←</button>
        <div class="spacer"></div>
      </div>

      <div class="item" style="cursor:default;">
        <div style="font-weight:800; font-size:18px;">${escapeHtml(p.title)}</div>
        <div class="meta">
          <span>${p.author_type === "system" ? "캐릭터" : "친구"}</span>
          <span>${fmtTime(p.created_at)}</span>
          <span>댓글 ${p.comment_count ?? 0}</span>
        </div>
        <div style="margin-top:10px; white-space:pre-wrap;">${escapeHtml(p.body || "")}</div>
      </div>

      <div style="height:12px;"></div>

      <div class="item" style="cursor:default;">
        <div style="font-weight:700;">댓글</div>
        <textarea id="commentInput" placeholder="댓글을 적어줘"></textarea>
        <div class="row">
          <button class="btnPrimary" id="commentSubmit">등록</button>
        </div>
        <div class="danger" id="commentErr" style="display:none;"></div>
      </div>

      <div style="height:12px;"></div>
      <div class="list">${comments || "<div class='hint'>첫 댓글을 달아보세요.</div>"}</div>
    `;

    el("btnBack").onclick = () => history.back();

    el("commentSubmit").onclick = async () => {
      const text = (el("commentInput").value || "").trim();
      const errEl = el("commentErr");
      errEl.style.display = "none";

      if (!text) return;

      try {
        await ensureGuest();
        await api(`/api/v1/posts/${p.id}/comments`, { method: "POST", body: JSON.stringify({ body: text }) });
        // reload detail
        await loadPost(p.id);
        renderPostDetail();
      } catch (e) {
        // nickname required -> show nickname modal
        if (String(e.message).includes("nickname_required")) {
          openNickname(async () => {
            await api(`/api/v1/posts/${p.id}/comments`, { method: "POST", body: JSON.stringify({ body: text }) });
            await loadPost(p.id);
            renderPostDetail();
          });
          return;
        }
        errEl.textContent = e.message;
        errEl.style.display = "block";
      }
    };
  }

  // --- Modals actions ---
  function openNickname(onSuccess) {
    nickErr.style.display = "none";
    nickInput.value = "";
    openModal(nickModal);

    el("nickCancel").onclick = () => closeModal(nickModal);

    el("nickSave").onclick = async () => {
      const name = nickInput.value.trim();
      nickErr.style.display = "none";
      try {
        await ensureGuest();
        await api("/api/v1/guest/nickname", { method: "POST", body: JSON.stringify({ nickname: name }) });
        closeModal(nickModal);
        if (onSuccess) await onSuccess();
      } catch (e) {
        nickErr.textContent = e.message;
        nickErr.style.display = "block";
      }
    };
  }

  function openAdmin() {
    adminErr.style.display = "none";
    adminKeyInput.value = "";
    openModal(adminModal);

    el("adminKeyCancel").onclick = () => closeModal(adminModal);

    el("adminKeySave").onclick = () => {
      const k = adminKeyInput.value.trim();
      if (!k) {
        adminErr.textContent = "키를 입력하세요";
        adminErr.style.display = "block";
        return;
      }
      ADMIN_KEY = k; // memory only
      closeModal(adminModal);
      // return to home
      location.hash = "#home";
    };
  }

  function openCompose({ mode, characterId }) {
    composeErr.style.display = "none";
    composePostTitle.value = "";
    composePostBody.value = "";
    composeCharRow.style.display = "none";

    if (mode === "free") {
      composeTitle.textContent = "자유게시판 글쓰기";
      composeCharRow.style.display = "none";
    } else if (mode === "char") {
      composeTitle.textContent = "캐릭터로 글쓰기(관리자)";
      composeCharRow.style.display = "";
      composeCharId.value = characterId || "";
    }

    openModal(composeModal);

    el("composeCancel").onclick = () => closeModal(composeModal);

    el("composeSubmit").onclick = async () => {
      const title = composePostTitle.value.trim();
      const body = composePostBody.value.trim();
      composeErr.style.display = "none";
      if (title.length < 2) return showComposeErr("제목을 2글자 이상");
      if (body.length < 2) return showComposeErr("내용을 2글자 이상");

      try {
        await ensureGuest();
        if (mode === "free") {
          await api("/api/v1/boards/free/posts", { method: "POST", body: JSON.stringify({ title, body }) });
          closeModal(composeModal);
          await loadFree();
          renderFree();
          return;
        }

        // char mode
        if (!ADMIN_KEY) return showComposeErr("관리자 모드가 필요합니다");
        const cid = composeCharId.value.trim();
        if (!cid) return showComposeErr("characterId 필요");

        await api(`/api/v1/admin/characters/${encodeURIComponent(cid)}/posts`, {
          method: "POST",
          headers: { "X-Admin-Key": ADMIN_KEY },
          body: JSON.stringify({ title, body }),
        });
        closeModal(composeModal);
        // reload character
        await loadCharacter(cid);
        renderCharacter();
      } catch (e) {
        if (String(e.message).includes("nickname_required")) {
          openNickname(async () => {
            // retry after nickname set
            if (mode === "free") {
              await api("/api/v1/boards/free/posts", { method: "POST", body: JSON.stringify({ title, body }) });
              closeModal(composeModal);
              await loadFree();
              renderFree();
            }
          });
          return;
        }
        showComposeErr(e.message);
      }
    };

    function showComposeErr(msg) {
      composeErr.textContent = msg;
      composeErr.style.display = "block";
    }
  }

  // --- Loads ---
  async function loadHome() {
    await ensureGuest();
    const data = await api("/api/v1/characters", { method: "GET" });
    state.characters = data.characters || [];
  }

  async function loadCharacter(id) {
    await ensureGuest();
    const c = await api(`/api/v1/characters/${encodeURIComponent(id)}`, { method: "GET" });
    state.char = c.character;

    const p = await api(`/api/v1/characters/${encodeURIComponent(id)}/posts?limit=20&offset=0`, { method: "GET" });
    state.charPosts = p.posts || [];
  }

  async function loadFree() {
    await ensureGuest();
    const p = await api(`/api/v1/boards/free/posts?limit=30&offset=0`, { method: "GET" });
    state.freePosts = p.posts || [];
  }

  async function loadPost(id) {
    await ensureGuest();
    const d = await api(`/api/v1/posts/${encodeURIComponent(id)}`, { method: "GET" });
    state.postDetail = d;
  }

  // --- Router ---
  async function route() {
    const h = location.hash || "#home";

    try {
      if (h === "#admin") {
        openAdmin();
        return;
      }

      if (h.startsWith("#u=")) {
        const id = decodeURIComponent(h.slice(3));
        await loadCharacter(id);
        renderCharacter();
        return;
      }

      if (h.startsWith("#p=")) {
        const id = decodeURIComponent(h.slice(3));
        await loadPost(id);
        renderPostDetail();
        return;
      }

      if (h === "#free") {
        await loadFree();
        renderFree();
        return;
      }

      // default: home
      await loadHome();
      renderHome();

    } catch (e) {
      view.innerHTML = `<div class="danger">에러: ${escapeHtml(e.message || String(e))}</div>`;
    }
  }

  // --- Header buttons ---
  el("tabHome").onclick = () => location.hash = "#home";
  el("tabFree").onclick = () => location.hash = "#free";

  el("meBtn").onclick = () => openNickname();

  window.addEventListener("hashchange", route);

  // start
  route();

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒˆ ë¬´ì§€ê°œ ìœ ì¹˜ì› ì´ì•¼ê¸°íŒ</title>
  <style>
    :root { --main: #FFB7B2; --sub: #FFDAC1; --bg: #FFFFD1; --text: #5D4037; }
    @import url('https://fonts.googleapis.com/css2?family=Gaegu&display=swap');
    body { font-family: 'Gaegu', cursive; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 70px; font-size: 1.2rem; }
    header { background: var(--main); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .container { max-width: 500px; margin: 0 auto; padding: 15px; }
    .card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 0px var(--sub); border: 2px solid var(--sub); }
    .post-author { font-weight: bold; color: #FF6B6B; font-size: 0.9rem; }
    .post-content { margin: 10px 0; line-height: 1.4; }
    input, textarea { width: 100%; border: 2px solid var(--sub); border-radius: 10px; padding: 10px; font-family: inherit; font-size: 1.1rem; box-sizing: border-box; }
    button { background: var(--main); border: none; border-radius: 10px; color: white; padding: 10px 20px; cursor: pointer; font-family: inherit; width: 100%; margin-top: 5px; }
    .nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 2px solid var(--sub); }
    .nav-item { flex: 1; text-align: center; padding: 15px; cursor: pointer; }
    #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100; }
    .modal-box { background: white; padding: 25px; border-radius: 20px; width: 80%; text-align: center; }
  </style>
</head>
<body>

<header>
  <h1 id="view-title">ğŸŒˆ ë¬´ì§€ê°œ ì´ì•¼ê¸°íŒ</h1>
</header>

<div class="container" id="app">
  </div>

<div class="nav">
  <div class="nav-item" onclick="location.hash='#home'">ğŸ¡ í™ˆ</div>
  <div class="nav-item" onclick="location.hash='#free'">ğŸ“¢ ê²Œì‹œíŒ</div>
</div>

<div id="modal">
  <div class="modal-box">
    <h2>ğŸ“› ì´ë¦„í‘œë¥¼ ë§Œë“¤ì–´ìš”!</h2>
    <p>ìš°ë¦¬ë°˜ ì¹œêµ¬ë“¤ì´ ì•Œì•„ë³¼ ìˆ˜ ìˆê²Œ<br>ì´ë¦„ì„ ì ì–´ì£¼ì„¸ìš”.</p>
    <input type="text" id="nick-input" placeholder="ì˜ˆ: ê·€ìš”ë¯¸ì‚¬ì">
    <button onclick="saveNickname()">êµì‹¤ ì…ì¥!</button>
  </div>
</div>

<script>
  // 1. ìì‹ ì˜ Worker ì£¼ì†Œë¡œ ìˆ˜ì • í•„ìˆ˜!
  const API_URL = "rainbow-bbs-api.irunaru.workers.dev"; 
  
  let myNick = localStorage.getItem('bbs_nick');
  let myGid = localStorage.getItem('bbs_gid') || crypto.randomUUID();

  async function init() {
    if (!myNick) {
      document.getElementById('modal').style.display = 'flex';
    } else {
      localStorage.setItem('bbs_gid', myGid);
      window.addEventListener('hashchange', router);
      router();
    }
  }

  async function saveNickname() {
    const nick = document.getElementById('nick-input').value.trim();
    if (nick.length < 2) return alert("ë‘ ê¸€ì ì´ìƒ ì¨ì£¼ì„¸ìš”!");
    
    await fetch(`${API_URL}/api/v1/guest/init`, {
      method: 'POST',
      body: JSON.stringify({ guest_id: myGid, nickname: nick })
    });
    
    localStorage.setItem('bbs_nick', nick);
    localStorage.setItem('bbs_gid', myGid);
    location.reload();
  }

  async function router() {
    const hash = location.hash || '#home';
    const app = document.getElementById('app');
    
    if (hash === '#home') {
      app.innerHTML = "ë¡œë”© ì¤‘...";
      const chars = await (await fetch(`${API_URL}/api/v1/characters`)).json();
      app.innerHTML = `<h3>ìš°ë¦¬ë°˜ ì„ ìƒë‹˜ê³¼ ì¹œêµ¬ë“¤</h3>` + chars.map(c => `
        <div class="card" onclick="alert('${c.bio}')">
          <span style="font-size:2rem">${c.avatar_url || 'ğŸ‘¤'}</span>
          <strong>${c.display_name}</strong>
        </div>
      `).join('');
    } 
    
    else if (hash === '#free') {
      app.innerHTML = `
        <div class="card">
          <textarea id="post-input" placeholder="ë¬´ìŠ¨ ì´ì•¼ê¸°ë¥¼ í• ê¹Œ?"></textarea>
          <button onclick="writePost()">ê¸€ì“°ê¸°</button>
        </div>
        <div id="post-list">ë¡œë”© ì¤‘...</div>
      `;
      loadPosts();
    }

    else if (hash.startsWith('#p=')) {
      const postId = hash.split('=')[1];
      showDetail(postId);
    }
  }

  async function loadPosts() {
    const posts = await (await fetch(`${API_URL}/api/v1/posts`)).json();
    document.getElementById('post-list').innerHTML = posts.map(p => `
      <div class="card" onclick="location.hash='#p=${p.id}'">
        <div class="post-author">${p.author_type === 'system' ? 'ğŸŒŸ' : 'ğŸ‘¤'} ${p.guests?.nickname || p.author_name}</div>
        <div class="post-content">${p.body}</div>
        <div style="font-size:0.8rem; color:#aaa;">ëŒ“ê¸€ ë³´ê¸°...</div>
      </div>
    `).join('');
  }

  async function showDetail(postId) {
    const app = document.getElementById('app');
    // ì‹¤ì œë¡œëŠ” ë‹¨ì¼ ê²Œì‹œê¸€ APIë¥¼ í˜¸ì¶œí•´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„  ê°„ë‹¨íˆ êµ¬í˜„
    app.innerHTML = `<div class="card">ë¡œë”© ì¤‘...</div>`;
    
    // ëŒ“ê¸€ ëª©ë¡ê³¼ ìƒì„¸ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ëŠ” ë¡œì§ (ê¸°ì¡´ êµ¬í˜„ ì°¸ê³ )
    // ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ê°„ë‹¨í•œ UIë§Œ ë¨¼ì € í‘œì‹œ
    app.innerHTML = `
      <button onclick="location.hash='#free'">â¬…ï¸ ëª©ë¡ìœ¼ë¡œ</button>
      <div class="card" id="detail-content">ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      <div id="comment-list"></div>
      <div class="card">
        <input id="cmt-input" placeholder="ëŒ“ê¸€ì„ ë‹¬ì•„ë³´ì„¸ìš”!">
        <button onclick="submitComment(${postId})">ë“±ë¡</button>
      </div>
    `;
  }

  async function submitComment(postId) {
    const body = document.getElementById('cmt-input').value;
    if (!body) return;

    try {
      const res = await fetch(`${API_URL}/api/v1/posts/${postId}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          guest_id: myGid,
          nickname: myNick,
          body: body
        })
      });
      if(res.ok) {
        alert("ëŒ“ê¸€ì´ ë‹¬ë ¸ì–´ìš”! ğŸ‰");
        document.getElementById('cmt-input').value = '';
        router(); // ìƒˆë¡œê³ ì¹¨
      }
    } catch(e) {
      alert("ë¬¸ì œê°€ ìƒê²¼ì–´ìš”: " + e.message);
    }
  }

  init();
</script>
</body>
</html>
